/*
** Annotator 1.2.6-dev-24fc0c5
** https://github.com/okfn/annotator/
**
** Copyright 2012 Aron Carroll, Rufus Pollock, and Nick Stenning.
** Dual licensed under the MIT and GPLv3 licenses.
** https://github.com/okfn/annotator/blob/master/LICENSE
**
** Built at: 2013-07-05 07:01:30Z
*/((function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b=Object.prototype.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a},d=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};Annotator.Plugin.LoreStore=function(b){function e(b,c){this._uuid=a(this._uuid,this),this._findById=a(this._findById,this),this._findAnnos=a(this._findAnnos,this),this._onError=a(this._onError,this),this._revertSave=a(this._revertSave,this),this._onLoadAnnotations=a(this._onLoadAnnotations,this),this.mapAnnotations=a(this.mapAnnotations,this),this._getAnnotations=a(this._getAnnotations,this),e.__super__.constructor.apply(this,arguments),this.annotations=[]}return c(e,b),e.prototype.events={annotationCreated:"annotationCreated",annotationDeleted:"annotationDeleted",annotationUpdated:"annotationUpdated"},e.prototype.options={annotationData:{},emulateHTTP:!1,prefix:"/lorestore",urls:{create:"/oa/",read:":id",update:":id",destroy:":id",search:"/oa/"}},e.prototype.destroy=function(){var a,b,c,d,f;e.__super__.destroy.call(this),d=this.annotations,f=[];for(b=0,c=d.length;b<c;b++)a=d[b],f.push(this.annotator.hideAnnotation(a));return f},e.prototype.pluginInit=function(){if(!Annotator.supported())return;return this.annotator.plugins.Auth?this.annotator.plugins.Auth.withToken(this._getAnnotations):this._getAnnotations()},e.prototype._getAnnotations=function(){return this.loadAnnotationsFromSearch()},e.prototype.annotationCreated=function(a){var b=this;return d.call(this.annotations,a)<0?(this.registerAnnotation(a),this._apiRequest("create",a,function(c){var d,e,f,g;d=b._findAnnos(c["@graph"])[0],d&&(g=d["@id"],e=d.annotatedAt,f=d.annotatedBy,f&&(f=b._findById(c["@graph"],f),f&&f.name&&(f=f.name,e&&(e=e["@value"],g==null&&(console.warn(Annotator._t("Warning: No ID returned from server for annotation "),a),b._revertSave(a,!0))))),b.updateAnnotation(a,{id:g,created:e,creator:f}));if(d==null)return console.warn(Annotator._t("Warning: no anno returned from server"),a),b._revertSave(a,!0)})):this.updateAnnotation(a,{})},e.prototype.annotationUpdated=function(a){var b=this;if(d.call(this.annotations,a)>=0)return this._apiRequest("update",a,function(c){return b.updateAnnotation(a,{})})},e.prototype.annotationDeleted=function(a){var b=this;if(d.call(this.annotations,a)>=0)return this._apiRequest("destroy",a,function(){return b.unregisterAnnotation(a)})},e.prototype.registerAnnotation=function(a){return this.annotations.push(a)},e.prototype.unregisterAnnotation=function(a){return this.annotations.splice(this.annotations.indexOf(a),1)},e.prototype.updateAnnotation=function(a,b){return d.call(this.annotations,a)<0?console.error(Annotator._t("Trying to update unregistered annotation!")):jQuery.extend(a,b),jQuery(a.highlights).data("annotation",a)},e.prototype.mapAnnotations=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;a==null&&(a={}),d=[],c=this._findAnnos(a["@graph"]);for(q=0,s=c.length;q<s;q++){b=c[q],e=this._findById(a["@graph"],b.hasBody),m=this._findById(a["@graph"],b.hasTarget),m&&m.hasSelector&&(n=this._findById(a["@graph"],m.hasSelector)),o={id:b["@id"],text:e.chars,ranges:[],motivation:b.motivatedBy},b.annotatedBy&&(f=this._findById(a["@graph"],b.annotatedBy),f&&(o.annotatedBy=b.annotatedBy,o.creator=f.name)),b.annotatedAt&&(o.created=b.annotatedAt["@value"]);if(n&&n["@type"]==="oa:Choice"){p=this._findById(a["@graph"],n["default"]),o.quote=p.exact,o.originalQuote=p.exact,o.prefix=p.prefix,o.suffix=p.suffix,i=function(a){switch(a["@type"]){case"austese:RangeSelector":return o.ranges=[{start:a["lorestore:startElement"],startOffset:a["lorestore:startOffset"],end:a["lorestore:endElement"],endOffset:a["lorestore:endOffset"]}];case"oa:TextPositionSelector":return o.startOffset=a.start,o.endOffset=a.end}};if(typeof n.item=="string")k=this._findById(a["@graph"],n.item),i(k);else if(typeof n.item=="object"){l=function(){var b,c,d,e;d=n.item,e=[];for(b=0,c=d.length;b<c;b++)g=d[b],e.push(this._findById(a["@graph"],g));return e}.call(this);for(r=0,t=l.length;r<t;r++)k=l[r],i(k)}}else n&&n.value&&n.value.match("xywh=")&&(h=jQuery("[data-id='"+m.hasSource+"']").find("img"),h.length>0&&(h=h[0]),j=n.value.split("=")[1].split(","),o.relativeSelection={x1:parseFloat(j[0]),y1:parseFloat(j[1]),x2:parseFloat(j[0])+parseFloat(j[2]),y2:parseFloat(j[1])+parseFloat(j[3]),width:parseFloat(j[2]),height:parseFloat(j[3]),image:h});d.push(o)}return d},e.prototype._onLoadAnnotations=function(a){a==null&&(a={}),this.loads--,this.annotations=this.mapAnnotations(a);if(this.loads===0)return this.annotator.loadAnnotations(this.annotations.slice())},e.prototype.loadAnnotationsFromSearch=function(a){var b,c=this;this.annotations=[],this.loads=0,b=!1,jQuery(this.element).find("[data-id]").andSelf().each(function(a,d){var e;e=jQuery(d).data("id");if(e)return b=!0,c.loads++,c._apiRequest("search",{annotates:e},c._onLoadAnnotations)});if(!b)return a||(a={}),a.annotates||(a.annotates=a.uri||document.location.href),this._apiRequest("search",a,this._onLoadAnnotations)},e.prototype.dumpAnnotations=function(){var a,b,c,d,e;d=this.annotations,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(JSON.parse(this._dataFor(a)));return e},e.prototype._apiRequest=function(a,b,c){var d,e,f,g,h;return d=b&&b.id,g=b&&b.resourceuri,h=this._urlFor(a,d,g),e=this._apiRequestOptions(a,b,c),f=jQuery.ajax(h,e),f._id=d,f._action=a,f._obj=b,f},e.prototype._apiRequestOptions=function(a,b,c){var d,e,f;return e=this._methodFor(a),f={type:e,headers:this.element.data("annotator:headers"),dataType:"json",headers:{Accept:"application/json","Content-Type":"application/json"},success:c||function(){},error:this._onError},this.options.emulateHTTP&&(e==="PUT"||e==="DELETE")&&(f.headers=jQuery.extend(f.headers,{"X-HTTP-Method-Override":e}),f.type="POST"),a==="search"?(f=jQuery.extend(f,{data:b}),f):(d=b&&this._dataFor(b),this.options.emulateJSON?(f.data={json:d},this.options.emulateHTTP&&(f.data._method=e),f):(f=jQuery.extend(f,{data:d,contentType:"application/json; charset=utf-8"}),f))},e.prototype._urlFor=function(a,b,c){var d;return a!=="read"&&a!=="search"&&a!=="create"?d=b:(d=this.options.prefix!=null?this.options.prefix:"",d+=this.options.urls[a],d=d.replace(/:resourceuri/,c?encodeURIComponent(c):encodeURIComponent(document.location.href))),d},e.prototype._methodFor=function(a){var b;return b={create:"POST",read:"GET",update:"PUT",destroy:"DELETE",search:"GET"},b[a]},e.prototype._dataFor=function(a){var b,c,d,e,f,g,h,i,j;jQuery.extend(a,this.options.annotationData),c="urn:uuid:"+this._uuid(),a.uri?i=a.uri:this.element.data("id")?i=this.element.data("id"):i=document.location.href,a.quote||a.relativeSelection?h="urn:uuid:"+this._uuid():h=i,j={"@context":{oa:"http://www.w3.org/ns/oa#",dc:"http://purl.org/dc/elements/1.1/",cnt:"http://www.w3.org/2011/content#",lorestore:"http://auselit.metadata.net/lorestore/",rdf:"http://www.w3.org/1999/02/22-rdf-syntax-ns#",austese:"http://austese.net/ns/oa/"},"@graph":[{"@id":a.id?a.id:"http://example.org/dummy","@type":"oa:Annotation","oa:hasBody":{"@id":c},"oa:hasTarget":{"@id":h}},{"@id":c,"@type":"cnt:ContentAsText","cnt:chars":a.text,"dc:format":"text/plain"}]},a.annotatedBy&&(j["@graph"][0]["oa:annotatedBy"]={"@id":a.annotatedBy},b={"@id":a.annotatedBy,"foaf:name":a.creator},j["@graph"].push(b)),a.created&&(j["@graph"][0]["oa:annotatedAt"]={"@value":a.created,"@type":"dcterms:W3CDTF"}),a.motivation&&(j["@graph"][0]["oa:motivatedBy"]={"@id":a.motivation});if(a.quote||a.relativeSelection)g="urn:uuid:"+this._uuid(),e={"@id":h,"@type":"oa:SpecificResource","oa:hasSource":{"@id":i},"oa:hasSelector":{"@id":g}},j["@graph"].push(e);return a.quote?f={"@id":g,"@type":"oa:Choice","oa:item":[{"@id":"urn:uuid:"+this._uuid(),"@type":"austese:RangeSelector","lorestore:startOffset":a.ranges[0].startOffset,"lorestore:endOffset":a.ranges[0].endOffset,"lorestore:startElement":a.ranges[0].start,"lorestore:endElement":a.ranges[0].end},{"@id":"urn:uuid:"+this._uuid(),"@type":"oa:TextPositionSelector","oa:start":a.startOffset,"oa:end":a.endOffset}],"oa:default":{"@type":"oa:TextQuoteSelector","@id":"urn:uuid:"+this._uuid(),"oa:exact":a.quote,"oa:prefix":a.prefix,"oa:suffix":a.suffix}}:a.relativeSelection&&(f={"@id":g,"@type":"oa:FragmentSelector","rdf:value":"xywh="+a.relativeSelection.x1+","+a.relativeSelection.y1+","+a.relativeSelection.width+","+a.relativeSelection.height}),j["@graph"].push(f),d=JSON.stringify(j),d},e.prototype._revertSave=function(a,b){var c,d,e,f,g;this.annotator.editor.load(a);if(b&&a.highlights){f=a.highlights,g=[];for(d=0,e=f.length;d<e;d++)c=f[d],g.push(Annotator.$(c).replaceWith(c.childNodes));return g}},e.prototype._onError=function(a){var b,c,d;b=a._action,c=Annotator._t("Unable to ")+b+Annotator._t(" this annotation"),d=a._obj,a._action==="search"?c=Annotator._t("Unable to search the store for annotations"):a._action==="read"&&!a._id&&(c=Annotator._t("Unable to ")+b+Annotator._t(" the annotations from the store")),d&&d.highlights&&(a._action==="create"&&this._revertSave(d,!0),a._action==="update"&&this._revertSave(d,!1));switch(a.status){case 401:c=Annotator._t("Sorry you are not allowed to ")+b+Annotator._t(" this annotation");break;case 404:c=Annotator._t("Unable to connect to the annotations store");break;case 500:c=Annotator._t("Something went wrong with the annotation store")}return Annotator.showNotification(c,Annotator.Notification.ERROR),console.error(Annotator._t("API request failed:")+(" '"+a.status+"'"))},e.prototype._findAnnos=function(a){var b,c,d,e;b=[];for(d=0,e=a.length;d<e;d++)c=a[d],c["@type"]==="oa:Annotation"&&b.push(c);return b},e.prototype._findById=function(a,b){var c,d,e,f;for(e=0,f=a.length;e<f;e++){d=a[e];if(d["@id"]===b){c=d;break}}return c},e.prototype._uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b,c;return b=Math.random()*16|0,c=a==="x"?b:b&3|8,c.toString(16)})},e}(Annotator.Plugin)})).call(this);