/*
** Annotator 1.2.6-dev-30b6543
** https://github.com/okfn/annotator/
**
** Copyright 2012 Aron Carroll, Rufus Pollock, and Nick Stenning.
** Dual licensed under the MIT and GPLv3 licenses.
** https://github.com/okfn/annotator/blob/master/LICENSE
**
** Built at: 2013-05-21 00:13:11Z
*/((function(){var a,b,c,d,e,f,g,h,i=Object.prototype.hasOwnProperty,j=function(a,b){function d(){this.constructor=a}for(var c in b)i.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};Annotator.Plugin.CharRangeSelection=function(c){function d(){d.__super__.constructor.apply(this,arguments)}return j(d,c),d.prototype.events={annotationCreated:"annotationCreated",annotationUpdated:"annotationUpdated",annotationsLoaded:"annotationsLoaded"},d.prototype.pluginInit=function(){!!Annotator.supported()},d.prototype.annotationCreated=function(a){var c,d,f,g,h,i,j,k;return f=50,a.ranges==null?a:(d=e(this.element.text()),i=a.ranges[0].normalize(this.annotator.wrapper[0]),c=new b,g=c.offsetsFromNormalizedRange(this.annotator.wrapper[0],i),j=e(a.quote),h=g.start-f<0?0:g.start-f,k=g.end+f>d.length?d.length:g.end+f,a.prefix=d.slice(h,g.start),a.suffix=d.slice(g.end,k),a.startOffset=g.start,a.endOffset=g.end,a)},d.prototype.annotationsLoaded=function(b){var c,d,e,f,g,h,i;for(e=0,g=b.length;e<g;e++){c=b[e];if(c.startOffset!=null)if(c.ranges==null||c.ranges.length===0)this._loadAnnotation(c);else if(c.originalQuote!==c.text){if(c.highlights!=null){i=c.highlights;for(f=0,h=i.length;f<h;f++)d=i[f],a(d).replaceWith(d.childNodes)}this._loadAnnotation(c)}}return b},d.prototype._loadAnnotation=function(a){var c,d,e,f,g;d=this.element[0],c=3,e={start:a.startOffset,end:a.endOffset},f=(new b).rangeFromCharOffsets(d,e),g=f.toString().trim();if(a.originalQuote!=null&&a.originalQuote!==g){console.log("PANIC: annotation is attached incorrectly. Should be: '"+a.originalQuote+"'. But is: '"+g+"'",{range:f,annotation:a});return}return a.ranges=[],a.ranges.push(f),this.annotator.setupAnnotation(a)},d}(Annotator.Plugin),b=function(){function b(){}var a;return a=3,b.prototype.offsetsOfString=function(a,b){var d,e,f;return f={},e=a.textContent.indexOf(b),d=a.textContent.lastIndexOf(b),e!==d&&console.log("PANIC - multiple positions of text found"),f.start=c(a.textContent,e),f.end=c(a.textContent,e+b.length),f},b.prototype.offsetsFromDomRange=function(a,b){return b=(new Annotator.Range.BrowserRange(b)).normalize(a),this.offsetsFromNormalizedRange(a,b)},b.prototype.offsetsFromNormalizedRange=function(b,c){var d,f,g;return g={},d=0,f=function(b){if(b.nodeType===a)return b===c.start&&(g.start=d),b===c.end&&(g.end=d+e(b.textContent).length),d+=e(b.textContent).length},h(b,f),g},b.prototype.rangeFromCharOffsets=function(b,c){var f,g,i,j,k;return k=c.start,g=c.end,f=0,j=document.createRange(),i=function(b){var c,h;if(b.nodeType===a)return c=e(b.textContent).length,c+f>k&&f<=k&&(h=d(b.textContent,k-f),j.setStart(b,h)),c+f>=g&&f<=g&&(h=d(b.textContent,g-f),j.setEnd(b,h)),f+=c},h(b,i),j},b}(),d=function(a,b){var c,d,e,g,h;e=0,d=0;if(b===e)return e;for(g=0,h=a.length;g<h;g++){c=a[g],e++,f.test(c)||d++;if(b===d)return e}return e},c=function(a,b){var c,d,e,g,h;d=0,e=0;if(b===e)return d;for(g=0,h=a.length;g<h;g++){c=a[g],e++,f.test(c)||d++;if(b===e)return d}return d},e=function(a){return a.replace(g,"")},f=/[\n\s]/,g=/[\n\s]/g,h=function(a,b){var c;b(a),a=a.firstChild,c=[];while(a)h(a,b),c.push(a=a.nextSibling);return c},a=Annotator.$})).call(this);